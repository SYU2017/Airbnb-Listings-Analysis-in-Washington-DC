<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>DC Airbnb Data</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="container">
        <div class="row">
                <div class="col-md-12 jumbotron text-center">
                    <h1>Airbnb Datasets Analysis in Washington, D.C.</h1>
                    <p>Use the interactive charts below to explore the Airbnb and Crime datasets</p>
                </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="well">
                    <h5>SELECT Neighborhood:</h5>
                    <select id="selDataset" onchange="optionChanged(this.value)"></select>
                </div>
                
                <div class="panel panel-primary col-md-6">
                    <div class="panel-heading">
                        <h3 class="panel-title">Entire Home Data</h3>
                    </div>
                    <div id="entire" class="panel-body"></div>
                </div>
           
                <div class="panel panel-primary col-md-6">
                    <div class="panel-heading">
                        <h3 class="panel-title">Private Room Data</h3>
                    </div>
                    <div id="private" class="panel-body"></div>
                </div>
          
                <div class="panel panel-primary col-md-6">
                    <div class="panel-heading">
                        <h3 class="panel-title">Shared Room Data</h3>
                    </div>
                    <div id="shared" class="panel-body"></div>
                </div>

                <div class="panel panel-primary col-md-6">
                    <div class="panel-heading">
                        <h3 class="panel-title">Neighborhood Crime Data</h3>
                    </div>
                    <div id="crime" class="panel-body"></div>
                </div>
            </div>

        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div id="pie"></div>
        </div>
        <div class="col-md-6">
            <div id="gauge"></div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div id="bubble"></div>
        </div>

    <script>

        
        function updateEntireData(entireData) {
            // Reference to Panel element for sample metadata
            var PANEL = document.getElementById("entire");
            // Clear any existing metadata
            PANEL.innerHTML = '';
            // Loop through all of the keys in the json response and
            // create new metadata tags
            for(var key in entireData) {
                h6tag = document.createElement("h6");
                h6Text = document.createTextNode(`${key}: ${entireData[key]}`);
                h6tag.append(h6Text);

                PANEL.appendChild(h6tag);
            }
        }

        function updatePrivateData(privateData) {
            // Reference to Panel element for sample metadata
            var PANEL = document.getElementById("private");
            // Clear any existing metadata
            PANEL.innerHTML = '';
            // Loop through all of the keys in the json response and
            // create new metadata tags
            for(var key in privateData) {
                h6tag = document.createElement("h6");
                h6Text = document.createTextNode(`${key}: ${privateData[key]}`);
                h6tag.append(h6Text);

                PANEL.appendChild(h6tag);
            }
        }

        function updateSharedData(sharedData) {
            // Reference to Panel element for sample metadata
            var PANEL = document.getElementById("shared");
            // Clear any existing metadata
            PANEL.innerHTML = '';
             // Loop through all of the keys in the json response and
            // create new metadata tags
            for(var key in sharedData) {
                h6tag = document.createElement("h6");
                h6Text = document.createTextNode(`${key}: ${sharedData[key]}`);
                h6tag.append(h6Text);

                PANEL.appendChild(h6tag);
            }
        }

        function updateCrimeData(crimeData) {

            // Reference to Panel element for sample metadata
            var PANEL = document.getElementById("crime");

            // Clear any existing metadata
            PANEL.innerHTML = '';
             // Loop through all of the keys in the json response and
            // create new metadata tags
            for(var key in crimeData) {
                h6tag = document.createElement("h6");
                h6Text = document.createTextNode(`${key}: ${crimeData[key]}`);
                h6tag.append(h6Text);

                PANEL.appendChild(h6tag);
            }
        }


        function buildCharts(listingData) {

            // Loop through listprice data and find the Airbnb list host information
            //var labels=Host ID: listingData[0]['host_id']\
                        //<br>Room Type: listingData[0]['room_type']\
                       // <br>Minimum Nights: listingData[0]['minimum_nights'] %s nights\
                        //<br>Availability_365: listingData[0]['availability_365'] %s days];
            // Build Bubble Chart
            var bubbleLayout = {
                margin: { t: 0 },
                hovermode: 'closest',
                xaxis: { title: 'Airbnb ID' }
            };
            var bubbleData = [{
                x: listingData[0]['airbnb_ids'],
                y: listingData[0]['price'],
                text: listingData[0]['room_type'],
                mode: 'markers',
                marker: {
                    size: listingData[0]['price'],
                    color: listingData[0]['airbnb_ids'],
                    colorscale: "Earth",
                }
            }];
            var BUBBLE = document.getElementById('bubble');
            Plotly.plot(BUBBLE, bubbleData, bubbleLayout);

            // Build Pie Chart
            var pieData = [{
                values: listingData[0]['price'].slice(0, 10),
                labels: listingData[0]['airbnb_ids'].slice(0, 10),
                hovertext: listingData[0]['room_type'].slice(0, 10),
                hoverinfo: 'hovertext',
                type: 'pie'
            }];

            var pieLayout = {
                margin: { t: 0, l: 0 }
            };

            var PIE = document.getElementById('pie');
            Plotly.plot(PIE, pieData, pieLayout);
        };

        function updateCharts(listingData) {

            var price = sampleData[0]['price'];
            var airbnb_id = sampleData[0]['airbnb_ids'];
            var labels = listingData[0]['room_type'];

            // Return the listing Description for each airbnb ID in the dataset
            //var labels = 'Host ID: listingData[0]['host_id']\
                        //<br>Room Type: listingData[0]['room_type']\
                       // <br>Minimum Nights: listingData[0]['minimum_nights'] %s nights\
                       // <br>Availability_365: listingData[0]['availability_365'] %s days]';
    

            // Update the Bubble Chart with the new data
            var BUBBLE = document.getElementById('bubble');
            Plotly.restyle(BUBBLE, 'x', [airbnb_id]);
            Plotly.restyle(BUBBLE, 'y', [price]);
            Plotly.restyle(BUBBLE, 'text', [labels]);
            Plotly.restyle(BUBBLE, 'marker.size', [price ]);
            Plotly.restyle(BUBBLE, 'marker.color', [airbnb_id]);

            // Update the Pie Chart with the new data
            // Use slice to select only the top 10 listing price for the pie chart
            var PIE = document.getElementById('pie');
            var pieUpdate = {
                values: [price.slice(0, 10)],
                labels: [airbnb_id.slice(0, 10)],
                hovertext: [labels.slice(0, 10)],
                hoverinfo: 'hovertext',
                type: 'pie'
            };
            Plotly.restyle(PIE, pieUpdate);
        }


        function getData(neighbourhood) {
            // Use a request to grab the json data needed for all charts
            Plotly.d3.json(`/listprice/${neighbourhood}`, function(error, listingData) {
                if (error) return console.warn(error);

                buildCharts (listingData);
                
            });

            Plotly.d3.json(`/crimedata/${neighbourhood}`, function(error, crimeData) {
                if (error) return console.warn(error);

                updateCrimeData(crimeData);
            });

            Plotly.d3.json(`/entirehome/${neighbourhood}`, function(error, entireData) {
                if (error) return console.warn(error);

                updateEntireData(entireData);
            });

            Plotly.d3.json(`/privateroom/${neighbourhood}`, function(error, privateData) {
                if (error) return console.warn(error);

                updatePrivateData(privateData);
            });

            Plotly.d3.json(`/sharedroom/${neighbourhood}`, function(error, sharedData) {
                if (error) return console.warn(error);

                updateSharedData(sharedData);
            });


            buildGauge(neighbourhood);

        }

        function getOptions() {

            // Grab a reference to the dropdown select element
            var selector = document.getElementById('selDataset');

            // Use the list of neighbourhood names to populate the select options
            Plotly.d3.json('/names', function(error, neighbourhoodNames) {
                for (var i = 0; i < neighbourhoodNames.length;  i++) {
                    var currentOption = document.createElement('option');
                    currentOption.text = neighbourhoodNames[i];
                    currentOption.value = neighbourhoodNames[i]
                    selector.appendChild(currentOption);
                }

                getData(neighbourhoodNames[0], buildCharts);
            })
        }

        function optionChanged(newneighbourhood) {
            // Fetch new data each time a new sample is selected
            getData(newneighbourhood, updateCharts);
        }

        function init() {
            getOptions();
        }

        // Initialize the dashboard
        init();


        
        function buildGauge(neighbourhood) {

            Plotly.d3.json(`/crimerate/${neighbourhood}`, function(error, crimerateData) {
                if (error) return console.warn(error);
                // Enter the washing frequency between 0 and 180
                var level = crimerateData*20;

                // Trig to calc meter point
                var degrees = 180 - level,
                    radius = .5;
                var radians = degrees * Math.PI / 180;
                var x = radius * Math.cos(radians);
                var y = radius * Math.sin(radians);

                // Path: may have to change to create a better triangle
                var mainPath = 'M -.0 -0.05 L .0 0.05 L ',
                    pathX = String(x),
                    space = ' ',
                    pathY = String(y),
                    pathEnd = ' Z';
                var path = mainPath.concat(pathX,space,pathY,pathEnd);

                var data = [{ type: 'scatter',
                x: [0], y:[0],
                    marker: {size: 12, color:'850000'},
                    showlegend: false,
                    name: 'Crime Rate',
                    text: level,
                    hoverinfo: 'text+name'},
                { values: [50/9, 50/9, 50/9, 50/9, 50/9, 50/9, 50/9, 50/9, 50/9, 50],
                rotation: 90,
                text: ['8-9', '7-8', '6-7', '5-6', '4-5', '3-4', '2-3', '1-2', '0-1', ''],
                textinfo: 'text',
                textposition:'inside',
                marker: {
                    colors:[
                        'rgba(0, 105, 11, .5)', 'rgba(10, 120, 22, .5)',
                        'rgba(14, 127, 0, .5)', 'rgba(110, 154, 22, .5)',
                        'rgba(170, 202, 42, .5)', 'rgba(202, 209, 95, .5)',
                        'rgba(210, 206, 145, .5)', 'rgba(232, 226, 202, .5)',
                        'rgba(240, 230, 215, .5)', 'rgba(255, 255, 255, 0)']},
                labels: ['8-9', '7-8', '6-7', '5-6', '4-5', '3-4', '2-3', '1-2', '0-1', ''],
                hoverinfo: 'label',
                hole: .5,
                type: 'pie',
                showlegend: false
                }];

                var layout = {
                shapes:[{
                    type: 'path',
                    path: path,
                    fillcolor: '850000',
                    line: {
                        color: '850000'
                    }
                    }],
                title: '<b>Crime Rate per Neighborhood  </b> <br> Washington DC 2017 ',
                height: 500,
                width: 500,
                xaxis: {zeroline:false, showticklabels:false,
                            showgrid: false, range: [-1, 1]},
                yaxis: {zeroline:false, showticklabels:false,
                            showgrid: false, range: [-1, 1]}
                };

                var GAUGE = document.getElementById('gauge');
                Plotly.newPlot(GAUGE, data, layout);
            });
        };

    </script>


</body>
</html>
